---
title: "campaign_food_spending"
author: "Dylan Manfre"
date: "2023-08-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

#libraries
library(tidyverse)
library(tidycensus)
library(janitor)
library(lubridate)
#install.packages("ipumsr")
library(ipumsr)
```


*** Describing my first steps and initial process ***

I downloaded data from the FEC.gov with seven search term filters to relate to food. I ran some basic group_by and summarize codes to analyse the initial databsae I downloaded (link is below). Then we determined that it would be better to get the bulk data from the individual two-year cycles from 2011 until today. We picked 2011 because of a USA Today story published in 2014 that analyzed it from 2011-2014. We determined that using open refine on a larger standardized dataset would be best to clean up the organizational names. 

Below we loaded in the individual two-year cycles from 2011 to today and standarized seach_terms and column names for when we load in the data. 

 - Link: https://www.fec.gov/data/disbursements/?data_type=processed&two_year_transaction_period=2012&two_year_transaction_period=2014&two_year_transaction_period=2016&two_year_transaction_period=2018&two_year_transaction_period=2020&two_year_transaction_period=2022&two_year_transaction_period=2024&min_date=01%2F01%2F2011&max_date=12%2F31%2F2024&recipient_state=DC&recipient_state=MD&recipient_state=VA&disbursement_description=FOOD&disbursement_description=DRINKS&disbursement_description=MEALS&disbursement_description=CATERING&disbursement_description=DINING&disbursement_description=BEVERAGE&disbursement_description=MEETING&disbursement_description=EVENTS

```{r}
#establishing column names and search terms to use in each dataset

column_names <- c("committee_id", "amndt_ind", "report_year", "report_type", "image_number", "line_number", "form_tp_cd", "sched_tp_cd", "recipient_name", "recipient_city", "recipient_state", "zip_code", "disbursement_date", "disbursement_amount", "transaction_pgi", "disbursement_description", "category", "category_desc", "memo_cd", "memo_text", "entity_type", "sub_id", "file_num", "tran_id", "back_ref_tran_id")  # Add your column names here

#search_terms to use in the loops and in each dataset
search_terms <- c("FOOD", "BEVERAGE", "DINING", "MEAL", "CATERING", "DRINK", "EVENT")

```

What I think the next steps should be after Derek looks at the code

1. Derek looks at code and provides comments
2. Combine all the datasets to make a master set showing 2011-today.
3. Add in the committee_id to the list so we can see the committees on the transactions.
4. Filter out the individuals because we only want to see places of business. 
5. Use open refine to standardize the business names and make sure they are all correct.
6. Use some of the code I wrote for the Booker/Wawa piece to gather info about the DMV spending.
7. Focus on the zip_codes surrounding Centeral/W. Maryland, DC and northern Virginia to establish DMV.
8. Analyze the important committees as well as the resturants and see what questions arise.
    - Does this place frequently get politicans outside of the DMV (Check master set)
    - Is this a well-known place or just for politicans.
    - Does the House of Reps eat at places the Senate doesn't?
    - Does Biden factor into this at all?

----------------------

General things
- makes self a readme file (an intro to the project elevator pitch)
- Good thing for me to do is to clean up the early work (if I have code not using anymore, I can repalce it with sentence that describe what I was trying to do. Include links and things I've learned.)
- Where I start the bulk downloads: I should add narrative to this saying heres why I added it.
- When I define a variable like search_terms. Define them once and then use again. Not repeatedly
- If im looking for a cleaner way to do this, I can turn this into a loop and have each cycle be a loop. 

- Next steps are good. Committee master, will load the file. 

-----------------------

Today's steps
Replace the older stuff, describing what I did -- DONE
Clean up the repating code by eliminating what is duplicates. (defining a variable once) -- DONE
Think of the steps that I need to put in the loop and put them in order for every cycle.

Steps and writing code for the loop
column_names
search_terms
load data
filter for DMV
zip_code to be 5 digits
making dates yyyy-mm-dd
Add the search_terms to the filter(str_detect
-----------------------------------------------


The loop establishes a list of functions to run on each dataset. The cycles value is populated with the years. Then the paste0 saved to the path, has the file path.
Then It reads in the file, filters out IND and all staes not DC, MD and VA. It formats the zip_code column, disbursement_date column and search_terms to be proper. THen it binds all the rows together. 


```{r}
#establishing and trying out things for the loop

dmv_foods_combined <- tibble()

# Define a list of years
cycles <- c('1112', '1314', '1516','1718','1920','2122','2324')
# Create a for loop to execute functions
for (cycle in cycles) {
  
    # need to build the path to the .txt file
    path <- paste0("~/Downloads/data", cycle,".txt")
    print(path)
    dmv_food <- read_delim(path, delim = "|", col_names = column_names)
    dmv_food_filtered <- dmv_food %>% 
    filter(recipient_state == "DC"| recipient_state == "MD" | recipient_state == "VA") %>%
    filter(entity_type != "IND") %>% 
    mutate(zip_code = str_sub(zip_code, start=1L, end=5L)) %>%
    mutate(disbursement_date=mdy(disbursement_date)) %>%
    filter(str_detect(disbursement_description, str_c(search_terms, collapse = "|")))
    dmv_foods_combined <- bind_rows(dmv_foods_combined, dmv_food_filtered)
}


# fix the dates that havent happened yet and I can do that by looking at the image number on FEC. 


# FOR OPEN REFINE I WANT A LIST OF UNIQUE RESTURANTS. 

#RETAIN HOW IT ORIGINALLY APPEARS AND THEN MAKE A COPY OF THE COLUMN.


write_csv(dmv_foods_combined, "data/dmv_foods_combined.csv")

```


```{r}
#What are the entity types

dmv_foods_combined %>% 
group_by(entity_type) %>% 
count()

#ORG has the most with 208,760 transactions. Need to see what types of places make up that entity_type column.

dmv_foods_combined %>% 
filter(entity_type == "ORG") %>% 
group_by(recipient_name) %>% 
summarize(total = sum(disbursement_amount)) %>% 
arrange(desc(total))

#This is showing that not many of the top recipients in the ORG category are actual food establishments

```


```{r}
#Creating a column of the recipients to be cleaned in Open Refine
distinct_columns <- dmv_foods_combined %>% 
distinct(recipient_name) %>% 
mutate(cleaned_names = recipient_name)

write_csv(distinct_columns, "data/distinct_columns.csv")



```


```{r}
#reading back the cleaned district columns

district_cols_cleaned <- read_csv("data/recipient_names_cleaned.csv")

district_cols_cleaned %>% 
group_by(cleaned_names) %>% 
count() %>% 
arrange(n)

#Methodology: brought back the cleaned district columns after standardizing and clustering in open refine. I put a Y in a "exclude" column because those recipient names are not related to food or food establishments. One method of getting rid of those names was doing that. Another is joining the district_cols_cleaned dataframe back to dmv_foods_combined and then filtering out everything that is not an ORG entity_type

```

```{r}
#Trying to see what type of places are in the other categories in Entity_type. This will help. determine more I should exclude in Google Sheets. From there, I can gather more key words to label Y when I exclude them later on.


dmv_foods_combined %>% 
group_by(recipient_name, disbursement_description) %>% 
filter(entity_type == "ORG") %>% 
select(recipient_name, disbursement_description, entity_type)

# In addition to cleaning the names in sheets, I think a good way to find out what I need to exclude is by looking at the disbursement description. Because I don't want transactions that ahve to do with general committee stuff or meetings. I want places where they actually spend money on food.

```

Progress from Sept. 15, 2023



#One thought I had would be to export the cleaned_nammes but put the disbursement_description next to it so we can see the reason for the transaction. I think this would help understand what was really used for a food expense and what was not. I commented out what I think the code should look like. 

names_and_descriptions <- dmv_foods_combined %>% 
distinct(recipient_name, disbursement_description) %>% 
mutate(cleaned_names = recipient_name)
#group_by(recipient_name, disbursement_description) %>% 
#select(recipient_name, disbursement_description)


Sept. 19 update
*** Because Dylan is a little silly we need to start over with the exclusions in Google sheets. The problem was that some records got deleted accidentially. We dont exactly know how it happened but now I can filter again in sheets labeling the records I want to exlcude with a 'y'. ***


Joinign back in the data for exclusions

Steps: load exclusions dataset, 
      join it to dmv_foods combined based on recipient_name column (or district_cols_cleaned?), 
      filter everything where exclusion != "y"
      continue doing exclusions based on disbursement_discription
      
```{r}
#loading in exclusions
exclusions <- read_csv("data/cleaned_names_attempt_2.csv")

exclusions <- exclusions %>% 
select(-Notes)


view(exclusions)
```


```{r}
#joining exclusions to dmv_foods_combined

dmv_foods_combined <- dmv_foods_combined %>% 
inner_join(exclusions, by = "recipient_name")

dmv_foods_combined <- dmv_foods_combined %>% 
  mutate(exclude_rd1 = case_when(is.na(exclude) ~ "n", TRUE ~ exclude))
# entries labeled n are ones we want to keep in our analysis

#removing exlcusions
round2_exclusion <- dmv_foods_combined %>% 
filter(exclude_rd1 != "y") %>% 
distinct(cleaned_names, disbursement_description, exclude_rd1) %>% 
select(cleaned_names, disbursement_description, exclude_rd1)
#working with 45,972 records to determine on the basis of disbursement_description
#These are records to keep in our analysis


```

```{r}
round2_exclusion <- round2_exclusion %>% 
mutate(exclude_rd2 = NA) 

```

These are exclusions based on disbursement_description.
They are records that do not get at a personal meal expense or signify personal habits.
This also has some records of names I may have missed in the initial exclusion process RED TOP CAB was one of those names (line 261, line 265)

OR should this be excluding names based on disbursement discription?


Notes
- Fundraising Event put a Y next to Fogo De Chow which is a steakhouse. This is something I'd want to keep. Would that mean I shouldn't use Fundraising Events in the exclusion? Would it remove just the transactions based on that category?

- Do I also remove PAC catering because I'm not really concerned with PACs?

- Do I include the distinct(disbursement_description) part into the code because that significantly reduces the amount of descriptions? For yes: becuase it makes it easier to see what description im getting rid of. For no, becasue those descriptions are for transactions I want to get rid of but some I may want to keep.

- Finding that the word "event" doesn't give me much of the records I want to include in the analysis.... do we re run everything wihtout event as a search term?

- Use open refine on some of the disbursement_descriptions? Objective would be to miniize some of the unique lower quantity descriptions. Then I'd join the disbursement descriptions back to the round_2 exclusions?

- Do we expel transactions with discriptions that only appear more than X times?

To make it fewer lines I can set it up like this 

# Define a vector of disbursement descriptions and cleaned names to match
exclusion_terms <- c("terms")

round2_exclusion <- round2_exclusion %>%
  mutate(exclude_rd2 = ifelse(
    disbursement_description %in% exclusion_patterns | cleaned_names %in% exclusion_patterns,
    "y",
    NA_character_
  ))



```{r}
#working on exclusions based on disbursement_discription
#this populates a column called disbursement_exclusion with 
round2_exclusion <- round2_exclusion %>%
#distinct(disbursement_description) %>%  
mutate(exclude_rd2 = case_when(
    disbursement_description == "EVENT SUPPLIES" ~ "y", 
    disbursement_description == "FUNDRAISING EVENT" ~ "y",
    disbursement_description == "FUNDRAISING EVENT MANAGEMENT FEE & EXPENSES" ~ "y",
    cleaned_names == "RED TOP CAB" ~ "y",
    disbursement_description == "EVENT REGISTRATION FEES - NOT FOR A FEDERAL CANDIDATE" ~ "y",
    disbursement_description == "CAMPAIGN EVENT: FACILITY RENTAL" ~ "y",
    cleaned_names == "THE TOWNSEND GROUP" ~ "y",
    cleaned_names == "VERONA CITGO 0001295" ~ "y",
    cleaned_names == "WINDOWS CATERING COMPANY, INC." ~ "y",
    disbursement_description == "CATERING & ROOM RENTAL" ~ "y",
    disbursement_description == "FOOD FOR GOLF EVENT" ~ "y",
    disbursement_description == "EVENTS-SITE SUPPLIES" ~ "y",
    disbursement_description == "PAC ROOM RENTAL/EVENT SPACE" ~ "y",
    disbursement_description == "ROOM RENTAL & CATERING FOR DONOR MEETING" ~ "y",
    cleaned_names == "SUN TRUST BANK" ~ "y",
    disbursement_description == "EVENT ENTERTAINMENT" ~ "y",
    disbursement_description == "FC EVENT FACILITY & CATERING FEE" ~ "y",
    disbursement_description == "JFC EVENT FACILITY FEE" ~ "y",
    disbursement_description == "JFC EVENT SUPPLIES" ~ "y",
    disbursement_description == "DEPOSIT FOR SPRING BALL EVENT TO BE HELD 5/12/12" ~ "y",
    cleaned_names == "AVIS RENT A CAR" ~ "y",		
    cleaned_names == "SUPERSHUTTLE EXECUCA" ~ "y",	
   cleaned_names == "WINDOWS CATERING COMPANY, INC." ~ "y",	
   cleaned_names == "ADVANTAGE" ~ "y",	
   cleaned_names == "THE GROVE 1 AVIATION" ~ "y",	
    disbursement_description == "PAC CIGARS FOR EVENT" ~ "y",
    disbursement_description == "BANQUET CHARGES FOR EVENT" ~ "y",
     disbursement_description == "INVOICE FR EVENT" ~ "y",
     disbursement_description == "PAC EVENT TICKET" ~ "y",
  	 cleaned_names == "THE ASHMEAD GROUP" ~ "y",
      disbursement_description == "MBEPAC EVENT EXPENSE" ~ "y",
       disbursement_description == "PAC PRINTING/TECHNOLOGY/FOOD&BEV./COLLATERAL" ~ "y",
      disbursement_description == "2011 JULY EVENT" ~ "y",
      disbursement_description == "CAMPAIGN EVENT: ROOM DEPOSIT" ~ "y",  
      disbursement_description == "GIFT CERTIFICATES FOR EVENT" ~ "y", 
      disbursement_description == "CATERING & ROOM RENTAL" ~ "y", 
      disbursement_description == "EVENT PLANNING SERVICES" ~ "y", 
      disbursement_description == "VOTER OUTREACH FOOD & BEVERAGES" ~ "y", 
      disbursement_description == "PARTY BUILDING EVENT INVITATION POSTAGE" ~ "y",
      disbursement_description == "PARTY BUILDING EVENT COFFEE" ~ "y",
      disbursement_description == "PAC EVENT SITE RENTAL" ~ "y",
      disbursement_description == "EVENT REGISTRATION FEES" ~ "y",
      disbursement_description == "EVENT CATERING - NOT FOR A FEDERAL CANDIDATE" ~ "y",
       disbursement_description == "CASH FOR EVENT FEES AND TIPS" ~ "y",
      disbursement_description == "JFC CATERING AND LODGING EXPENSE" ~ "y",
      disbursement_description == "ERICPAC EVENT STAFFING" ~ "y",
      disbursement_description == "GENERIC FUNDRAISING EVENT TICKETS" ~ "y",
      disbursement_description == "CATERING FOR THANK YOU EVENT" ~ "y",
      cleaned_names == "JEREMY GOLD" ~ "y",
        cleaned_names == "US BOWLING" ~ "y",
      cleaned_names == "2005-10 NEIL FLETCHER WILSON" ~ "y",
      cleaned_names == "VENDORS UNDER $ 200" ~ "y",
      cleaned_names == "TOTAL PARTY & TOTAL FRIGHT" ~ "y",
      cleaned_names == "US CAPITOL HISTORICAL SOC" ~ "y",
      disbursement_description == "CATERING REIMBURSEMENT" ~ "y",
      disbursement_description == "EVENT DECORATIONS - SUPPLIES" ~ "y",
       disbursement_description == "FUNDRAISING EVENT PLANNER FEE" ~ "y",
   	  disbursement_description == "FUNDRAISER EVENT PLANNER FEE" ~ "y",
         	  disbursement_description == "EVENT EXPENSE - ROOM RENTAL DEPOSIT" ~ "y",
	              	  disbursement_description == "EVENT EXPENSE - PA SYSTEM RENTAL" ~ "y",
   cleaned_names == "PARTY CITY" ~ "y",
    disbursement_description == "PAC EVENT EXPENSE/RM RENTAL" ~ "y",
   	disbursement_description == "PAC EVENT EXPENSE/BANQUET/ROOM RENTAL" ~ "y",
    	disbursement_description == "EVENT ROOM & CATERING DEPOSIT" ~ "y",
      disbursement_description == "EVENT PRODUCTION" ~ "y",
      disbursement_description == "EVENT MATERIAL" ~ "y",
      disbursement_description == "EVENT FACILITY RENTAL" ~ "y",
      disbursement_description == "EVENT TICKETS" ~ "y",
      disbursement_description == "EVENT/SUPPLIES" ~ "y",
      disbursement_description == "EVENT/DECORATIONS" ~ "y",
      disbursement_description == "JFC EVENT TICKETS" ~ "y",
      cleaned_names == "CORDON EVENTS LLC" ~ "y",
      disbursement_description == "EVENT CONSULTING" ~ "y",
      disbursement_description == "EVENT DEPOSIT" ~ "y",
      disbursement_description == "EVENT FEE" ~ "y",
      disbursement_description == "EVENT FEES" ~ "y",
      disbursement_description == "EVENT FEES" ~ "y",
      disbursement_description == "EVENT/SOUND/STAGING" ~ "y",
      disbursement_description == "TICKETS FOR EVENT" ~ "y",
      disbursement_description == "EVENT - VENUE RENTAL" ~ "y",
      disbursement_description == "EVENT PLANNING" ~ "y",
      disbursement_description == "EVENT SECURITY" ~ "y",
      disbursement_description == "EVENT REGISTRATION" ~ "y",
      disbursement_description == "EVENT SPONSOR" ~ "y",
      disbursement_description == "EVENT PLANNING SERVICES" ~ "y",
      disbursement_description == "EVENT/SUPPLIES" ~ "y",
       disbursement_description == "SUPPLIES FOR FUNDRAISING EVENT" ~ "y",
   disbursement_description == "EVENT MUSIC" ~ "y",
   disbursement_description == "EVENT SPEAKER" ~ "y",
   disbursement_description == "EVENT ROOM RENT" ~ "y",
   disbursement_description == "EVENT ROOM RENTAL DEPOSIT" ~ "y", 
  disbursement_description == "EVENT ADVERTISING" ~ "y",
   disbursement_description == "EVENT MANGEMENT FEE" ~ "y",
   disbursement_description == "EVENT LIABILITY INSURANCE" ~ "y",
	disbursement_description == "OFFICE & EVENT SUPPLIES" ~ "y",
  disbursement_description == "EVENT VENUE & TICKET COSTS" ~ "y",
   disbursement_description == "PRIMARY WATCH EVENT" ~ "y",
  disbursement_description == "EVENT TRAVEL" ~ "y",
  disbursement_description == "JFC EVENT FACILITY FEE" ~ "y",
   disbursement_description == "EVENT EXPENSE - VENUE RENTAL" ~ "y",
 disbursement_description == "EVENT EXPENSE - TRANSPORTATION" ~ "y",
disbursement_description == "SECURITY FOR EVENT" ~ "y",
disbursement_description == "STAFF TRAINING EVENT" ~ "y",
disbursement_description == "EVENT VENUE LEASE" ~ "y",
cleaned_names == "JEREMY GOLD" ~ "y",
cleaned_names == "2005-10 NEIL FLETCHER WILSON" ~ "y",
disbursement_description == "REIMBURSEMENT FOR EVENT EXPENSES" ~ "y",
disbursement_description == "EVENTS-SITE SUPPLIES" ~ "y",
disbursement_description == "TICKETS FOR CAMPAIGN EVENT" ~ "y",
disbursement_description == "EVENT LOCATION" ~ "y",
disbursement_description == "EVENT PRODUCTION / STAGING" ~ "y",
disbursement_description == "EVENT RENTALS" ~ "y",
disbursement_description == "EVENTS/MEETINGS CREDIT INVOICE" ~ "y",
disbursement_description == "SUB-VENDOR: PAC FUNDRAISING EXP - CATERING/FOOD/BEV/ROOM USAGE" ~ "y",
disbursement_description == "EVENT - ROOM FEE" ~ "y",
disbursement_description == "EVENT - ENTERTAINMENT" ~ "y",
disbursement_description == "EVENT PHOTOGRAPHY" ~ "y",
disbursement_description == "EVENT EXPENSES - VENUE RENTAL AND CATERING" ~ "y",
disbursement_description == "EVENT PRODUCTION SERVICES" ~ "y",
disbursement_description == "EVENT SPACE RENTAL AND CATERING" ~ "y",
disbursement_description == "EVENT TRANSPORTATION" ~ "y",




      TRUE ~ NA_character_
  ))
#slice(35000:36000)

#using slice function to show me a range of the rows so that I dont have to slide the bar on the entire 45,000 row dataset

round2_exclusion %>% 
filter(exclude_rd2 == "y")


count_descriptions <- round2_exclusion %>% 
group_by(disbursement_description) %>% 
count() %>% 
arrange(desc(n))
view(count_descriptions)
view(round2_exclusion)
```






#next step is to join round2_exclusion back to dmv_foods_combined






