---
title: "campaign_food_spending"
author: "Dylan Manfre"
date: "2023-08-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

#libraries
library(tidyverse)
library(tidycensus)
library(janitor)
library(lubridate)
#install.packages("ipumsr")
library(ipumsr)
```

*** Early notes from Aug. 23 ***

- Years filtered for: 2011 to today
- States filtered fsor: DC, MD, VA
- Search terms I used in the FEC.gov site.
  - food, drinks, meals, catering, dining, beverage, meeting, events (produced a dataset with 274,352 results)
  - Link: https://www.fec.gov/data/disbursements/?data_type=processed&two_year_transaction_period=2012&two_year_transaction_period=2014&two_year_transaction_period=2016&two_year_transaction_period=2018&two_year_transaction_period=2020&two_year_transaction_period=2022&two_year_transaction_period=2024&min_date=01%2F01%2F2011&max_date=12%2F31%2F2024&recipient_state=DC&recipient_state=MD&recipient_state=VA&disbursement_description=FOOD&disbursement_description=DRINKS&disbursement_description=MEALS&disbursement_description=CATERING&disbursement_description=DINING&disbursement_description=BEVERAGE&disbursement_description=MEETING&disbursement_description=EVENTS
  

  

- We want to identify the purpose category as "Fundraising" or another term and make sure it doesn't say "travel" so we exclude those unnecessary transactions.



```{r}

# loading in the campaign_food_data.csv
campaign_food_data <- read_csv("data/campaign_food_data.csv")
head(campaign_food_data)

```


** I put in 7 filters to the FEC site with the above link. Shouldn't then there only be 7 categories that show up? **

```{r}
#counts for categories
campaign_food_data %>% 
group_by(disbursement_description) %>% 
count() %>% 
arrange(desc(n))

#recipient totals
category_totals <- campaign_food_data %>% 
group_by(recipient_name, recipient_state) %>% 
summarize(total_spent = sum(disbursement_amount)) %>% 
arrange(desc(total_spent))

#state totals
state_totals <-  campaign_food_data %>% 
group_by(recipient_state) %>% 
summarize(total_spent = sum(disbursement_amount)) %>% 
arrange(desc(total_spent))
#why is DC not showing up?
#Look for the NAs in the dataset

#use this block to try and filter for the NAs
campaign_food_data <- campaign_food_data %>% 
filter(!is.na(disbursement_amount))
#omitted image_number: 12020611921 becasue it showed up as a NA and FEC site said it was $0 anyway.
```

```{r}
#trying to see how many transactions there are in the years, based on the quater of the year?

#Then try to find out how much money was spent in that quarter
#Try to set up the columns: YEAR, QUARTER, NO. OF TRANSACTIONS, Q_TOTAL

#Which year had the most transactions
year_totals <-campaign_food_data %>% 
group_by(report_year) %>% 
count() %>%
arrange(desc(n))
#2018 had most transactions

#Showing which month was the most money spent
month_totals <- campaign_food_data %>% 
  mutate(month = floor_date(disbursement_date, "month")) %>% 
  group_by(month) %>% 
  summarise(total_amount = sum(disbursement_amount)) %>% 
  arrange(desc(total_amount))
# Nov. 2016 was when the msot money was spent... Trump was elected in this month. 
# Lots spent here for a few reasons: final stretch of campaigning,
# Nov doesnt appear again until No. 27 at Nov. 2018

# This codeblock is trying to filter and show the totals for all of Novembers. 

nov_totals <- campaign_food_data %>% 
  mutate(month = floor_date(disbursement_date, "month")) %>% 
  group_by(month) %>% 
  summarise(total_amount = sum(disbursement_amount)) %>% 
  filter(month(month) == 11) %>% 
  arrange(desc(total_amount))

```

** Should I use Open Refine to standardize some of the disbursement_descriptions
List of ones to standardist: FOOD AND BEVERAGE, FOOD & BEVERAGE, FOOD/BEVERAGES, FOOD / BEVERAGES, FOOD AND MEALS, FOOD & BEV, FOOD AND BEVERAGE EXPENSE

** RESTURANT MEALS IS A GOOD ONE TO HONE IN ON **




*** Generating new data from the Bulk Downloads section of FEC.gov ***

```{r}
#exporting the CSV for Derek on Aug. 28

write_csv(campaign_food_data, "data/campaign_food_data10.28.csv")

```


*** NOTE: THIS IS ONLY 2015-2016 DATA HERE *****


```{r}

column_names <- c("CMTE_ID", "AMNDT_IND", "REPORT_YEAR", "REPORT_TYPE", "IMAGE_NUM", "LINE_NUM", "FORM_TP_CD", "SCHED_TP_CD", "NAME", "CITY", "STATE", "ZIP_CODE", "DISBURSEMENT_DATE", "DISBURSEMENT_AMOUNT", "TRANSACTION_PGI", "PURPOSE", "CATEGORY", "CATEGORY_DESC", "MEMO_CD", "MEMO_TEXT", "ENTITY_TP", "SUB_ID", "FILE_NUM", "TRAN_ID", "BACK_REF_TRAN_ID")  # Add your column names here

new_food_data <- read_delim("~/Downloads/oppexp.txt", delim = "|", col_names = column_names)

# making the column names lower case
colnames(new_food_data) <- tolower(colnames(new_food_data))

#need to convert disbursement_date into a date field yyyy-mm-dd
#need to convert the zipcodes into a 5-digit field.



```



use strings and then test them all togeter

```{r}
new_category_totals <- new_food_data %>% 
group_by(purpose) %>% 
count() %>% 
arrange(desc(n))


new_food_data %>% 
filter(purpose == "FOOD AND BEV")

new_food_data %>% 
filter(purpose == "MEALS")

new_food_data %>% 
  filter(purpose == "FOOD")

new_food_data %>% 
  filter(purpose == "EVENT FOOD")

new_food_data %>% 
filter(purpose == "DINING EXPENSE")

new_food_data %>% 
filter(purpose == "FOOD AND BEVERAGE") #Keep this one and combine it with "FOOD AND BEV"

#Using the filter with str_detects here
new_food_data %>% 
filter(str_detect(purpose, "FOOD"))

new_food_data %>% 
filter(str_detect(purpose, "BEVERAGE"))
```


```{r}
# Next step is to save the purpose terms to a search_terms variable.
search_terms <- c("FOOD", "BEVERAGE", "MEALS", "EVENT", "DINING", "CATERING", "EVENTS")

filtered_data <- your_data_frame %>%
  filter(str_detect(purpose, str_c(search_terms, collapse = "|")))




```




